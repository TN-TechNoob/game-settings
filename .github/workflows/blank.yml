name: Create Release on Push

on:
  push:
    branches:
      - main  # 可以根據你的分支名稱修改這裡

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Create New Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: 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
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release ${{ github.run_number }}
        draft: false
        prerelease: false

    - name: Get Old Releases
      run: |
        echo "::set-output name=old_releases::$(gh release list --json name --limit 10)"
      env:
        GITHUB_TOKEN: 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

    - name: Delete Old Releases
      run: |
        OLD_RELEASES="${{ steps.get_old_releases.outputs.old_releases }}"
        if [[ $OLD_RELEASES == *"Release"* ]]; then
          IFS=$'\n' read -rd '' -a RELEASES <<< "$OLD_RELEASES"
          for release in "${RELEASES[@]}"; do
            if [[ $release != *"v${{ github.run_number }}"* ]]; then
              gh release delete "$release" -y
            fi
          done
        fi
      env:
        GITHUB_TOKEN: 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
